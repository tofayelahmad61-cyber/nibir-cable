<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Internet Billing ‚Äì Offline HTML App</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#334155; /* slate-700 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22c55e; /* green-500 */
      --accent-2:#60a5fa; /* blue-400 */
      --danger:#ef4444; /* red-500 */
      --warn:#f59e0b; /* amber-500 */
      --card:#0b1220; /* darker */
      --shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#020617);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(2,6,23,.8);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
    .brand h1{font-size:18px;margin:0;font-weight:700}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 12px;border:1px solid #1f2937;background:#0b1220;border-radius:999px;cursor:pointer;user-select:none}
    .tab.active{background:linear-gradient(135deg,#0ea5e9,#22c55e);color:#001b0a;font-weight:700}

    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-2{grid-template-columns:repeat(2,1fr)}}

    .card{background:radial-gradient(80% 120% at 50% -20%,rgba(96,165,250,.08),transparent 60%), #0b1220;border:1px solid #1f2937;border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px 0;font-size:16px}

    .stat{display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px dashed #253046;border-radius:14px;background:rgba(2,6,23,.6)}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #243042;background:#0a1020;color:var(--text)}
    input::placeholder,textarea::placeholder{color:#94a3b8}

    button{cursor:pointer}
    .btn{background:#10192b}
    .btn.primary{background:linear-gradient(135deg,#22c55e,#16a34a);color:#001b0a;font-weight:700}
    .btn.blue{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#001b2a;font-weight:700}
    .btn.warn{background:linear-gradient(135deg,#f59e0b,#f97316);color:#2b1001;font-weight:700}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#2b0000;font-weight:700}

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:10px;text-align:left}
    th{font-size:12px;text-transform:uppercase;opacity:.8}
    tr:hover{background:rgba(59,130,246,.06)}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
    .pill.active{background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.35)}
    .pill.inactive{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.35)}
    .pill.disconnected{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}

    .icon-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid #243042;background:#0a1020;cursor:pointer}

    .footer{opacity:.7;font-size:12px;margin-top:20px;text-align:center}
    .hidden{display:none}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px}

    .kbd{border:1px solid #334155;border-bottom-width:3px;border-radius:6px;padding:2px 6px;background:#0b1220}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"></div>
        <h1>Internet Billing (LocalStorage ‚Ä¢ Offline HTML)</h1>
      </div>
      <div class="tabs" id="tabs"></div>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px">
    <section id="view-dashboard" class="view"></section>
    <section id="view-customers" class="view hidden"></section>
    <section id="view-isps" class="view hidden"></section>
    <section id="view-olts" class="view hidden"></section>
    <section id="view-backup" class="view hidden"></section>
    <section id="view-help" class="view hidden"></section>
  </main>

  <script>
  // ======= Simple Offline DB (LocalStorage) =======
  const DB_KEY = 'ibill_db_v1';
  const now = new Date();
  function ym(d){return d.getFullYear()+ '-' + String(d.getMonth()+1).padStart(2,'0')}
  const CURR_YM = ym(now);

  const defaultDB = {
    meta:{version:1, createdAt:new Date().toISOString(), lastRunMonth: CURR_YM},
    isps:[
      {id: uid(), name:'ISP-1', packages:[{id:uid(), name:'Basic', speedMbps:20, price:600},{id:uid(), name:'Pro', speedMbps:50, price:900}]},
      {id: uid(), name:'ISP-2', packages:[{id:uid(), name:'Lite', speedMbps:10, price:400}]}
    ],
    olts:[{id:uid(), name:'OLT-1', onus:[]}],
    customers:[
      {id:uid(), name:'‡¶ï‡¶¨‡¶ø‡¶∞ ‡¶π‡ßã‡¶∏‡ßá‡¶®', phone:'01300xxxxxx', address:'', status:'active', ispId:null, packageId:null, price:600, due:0, payments:[], lastBilledMonth: CURR_YM}
    ]
  };

  function loadDB(){
    const raw = localStorage.getItem(DB_KEY);
    if(!raw){
      localStorage.setItem(DB_KEY, JSON.stringify(defaultDB));
      return structuredClone(defaultDB);
    }
    try{
      const db = JSON.parse(raw);
      if(!db.meta) db.meta = {version:1, createdAt:new Date().toISOString(), lastRunMonth: CURR_YM};
      return db;
    }catch(e){
      alert('‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ Backup/Restore ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
      return structuredClone(defaultDB);
    }
  }
  function saveDB(){
    localStorage.setItem(DB_KEY, JSON.stringify(DB));
    // light haptic via console :-)
    console.log('‚úì Saved');
  }
  function uid(){return Math.random().toString(36).slice(2,9)}

  let DB = loadDB();

  // ======= Monthly Auto-Billing =======
  function parseYM(s){const [y,m]=s.split('-').map(Number);return {y,m}}
  function monthsDiff(a,b){ // a -> b
    const A=parseYM(a), B=parseYM(b);
    return (B.y-A.y)*12 + (B.m-A.m);
  }
  function runAutoBilling(){
    const last = DB.meta.lastRunMonth || CURR_YM;
    const diff = monthsDiff(last, CURR_YM);
    if(diff<=0) return;
    DB.customers.forEach(c=>{
      if(c.status==='active'){
        const months = Math.max(1,diff); // catch-up
        c.due = (c.due||0) + (c.price||0)*months;
      }
    });
    DB.meta.lastRunMonth = CURR_YM;
    saveDB();
  }
  runAutoBilling();

  // ======= UI Helpers =======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function fmt(n){return new Intl.NumberFormat('bn-BD').format(Number(n||0))}
  function taka(n){return fmt(n) + ' ‡ß≥'}
  function statusPill(st){
    const map={active:['üü¢','active','‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü'], inactive:['üü°','inactive','‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü'], disconnected:['üî¥','disconnected','‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°']};
    const [dot,cls,txt] = map[st]||['‚ö™','inactive','‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ'];
    return `<span class="pill ${cls}">${dot} ${txt}</span>`
  }

  function renderTabs(){
    const tabs=[
      {id:'dashboard',label:'‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°'},
      {id:'customers',label:'‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï'},
      {id:'isps',label:'ISP/‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú'},
      {id:'olts',label:'OLT/ONU'},
      {id:'backup',label:'‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™/‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞'},
      {id:'help',label:'‡¶π‡ßá‡¶≤‡ßç‡¶™'}
    ];
    const el = $('#tabs');
    el.innerHTML = tabs.map(t=>`<div class="tab" data-tab="${t.id}">${t.label}</div>`).join('');
    el.addEventListener('click',e=>{
      const t = e.target.closest('.tab');
      if(!t) return;
      const id = t.dataset.tab;
      $$('.tab').forEach(x=>x.classList.toggle('active', x.dataset.tab===id));
      $$('.view').forEach(v=>v.classList.toggle('hidden', v.id!==`view-${id}`));
      // lazy renders
      if(id==='dashboard') renderDashboard();
      if(id==='customers') renderCustomers();
      if(id==='isps') renderISPs();
      if(id==='olts') renderOLTs();
      if(id==='backup') renderBackup();
      if(id==='help') renderHelp();
    });
    // default
    $$('.tab')[0].classList.add('active');
    renderDashboard();
  }

  // ======= Dashboard =======
  function renderDashboard(){
    const v = $('#view-dashboard');
    const total = DB.customers.length;
    const active = DB.customers.filter(c=>c.status==='active').length;
    const disc = DB.customers.filter(c=>c.status==='disconnected').length;
    const due = DB.customers.reduce((s,c)=>s+(c.due||0),0);
    const thisMonth = CURR_YM;
    const paidThisMonth = DB.customers.reduce((s,c)=>s + (c.payments||[]).filter(p=> (p.date||'').startsWith(thisMonth)).reduce((a,b)=>a+(b.amount||0),0),0);

    v.innerHTML = `
      <div class="grid cols-3">
        <div class="card">
          <h3>‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶™‡¶∞‡¶ø‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶®</h3>
          <div class="grid cols-3">
            <div class="stat"><div>‡¶Æ‡ßã‡¶ü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</div><strong>${fmt(total)}</strong></div>
            <div class="stat"><div>‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü</div><strong>${fmt(active)}</strong></div>
            <div class="stat"><div>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</div><strong>${fmt(disc)}</strong></div>
          </div>
          <div class="grid cols-2" style="margin-top:10px">
            <div class="stat"><div>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ</div><strong>${taka(due)}</strong></div>
            <div class="stat"><div>‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶Ü‡¶¶‡¶æ‡ßü</div><strong>${taka(paidThisMonth)}</strong></div>
          </div>
          <div class="toolbar" style="margin-top:10px">
            <button class="btn primary" id="btn-autobill">‡¶Ö‡¶ü‡ßã ‡¶¨‡¶ø‡¶≤ ‡¶ö‡¶æ‡¶≤‡¶æ‡¶® (‡¶è‡¶ñ‡¶®‡¶á)</button>
            <button class="btn blue" id="btn-new-customer">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</button>
          </div>
        </div>

        <div class="card">
          <h3>ISP ‡¶ì ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú</h3>
          ${DB.isps.map(i=>`<div class="stat"><div><strong>${i.name}</strong> ‚Äî ${i.packages.length} ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú</div><div class="mono">#${i.id}</div></div>`).join('')}
          <div class="toolbar" style="margin-top:10px">
            <button class="btn blue" id="btn-new-isp">‡¶®‡¶§‡ßÅ‡¶® ISP</button>
          </div>
        </div>

        <div class="card">
          <h3>OLT / ONU</h3>
          ${DB.olts.map(o=>`<div class="stat"><div><strong>${o.name}</strong> ‚Äî ONU: ${o.onus.length}</div><div class="mono">#${o.id}</div></div>`).join('')}
          <div class="toolbar" style="margin-top:10px">
            <button class="btn blue" id="btn-new-olt">‡¶®‡¶§‡ßÅ‡¶® OLT</button>
          </div>
        </div>
      </div>
    `;

    $('#btn-autobill').onclick = ()=>{ DB.meta.lastRunMonth = parseYM(DB.meta.lastRunMonth).y+ '-' + String(parseYM(DB.meta.lastRunMonth).m).padStart(2,'0'); // keep
      // bill one month instantly
      DB.customers.forEach(c=>{ if(c.status==='active') c.due = (c.due||0) + (c.price||0) });
      saveDB();
      renderDashboard();
      alert('‚úÖ ‡¶è‡¶ï ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶¨‡¶ø‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)‡•§');
    }
    $('#btn-new-customer').onclick = ()=> openCustomerForm();
    $('#btn-new-isp').onclick = ()=> openISPForm();
    $('#btn-new-olt').onclick = ()=> openOLTForm();
  }

  // ======= Customers =======
  function renderCustomers(){
    const v = $('#view-customers');
    const rows = DB.customers.map(c=>{
      const isp = DB.isps.find(x=>x.id===c.ispId);
      const pkg = isp?.packages?.find(p=>p.id===c.packageId);
      return `
        <tr>
          <td class="mono">${c.id}</td>
          <td><strong>${c.name||''}</strong><div class="mono" style="opacity:.7">${c.phone||''}</div></td>
          <td>${statusPill(c.status||'inactive')}</td>
          <td>${isp? isp.name: '‚Äî'}</td>
          <td>${pkg? `${pkg.name} ‚Ä¢ ${pkg.speedMbps} Mbps`: '‚Äî'}</td>
          <td>${taka(c.price||0)}</td>
          <td><strong>${taka(c.due||0)}</strong></td>
          <td>
            <div class="row">
              <button class="icon-btn" onclick="pay('${c.id}')">üí≥ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
              <button class="icon-btn" onclick="toggleStatus('${c.id}')">üîÅ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</button>
              <button class="icon-btn" onclick="openCustomerForm('${c.id}')">‚úèÔ∏è ‡¶è‡¶°‡¶ø‡¶ü</button>
              <button class="icon-btn" onclick="delCustomer('${c.id}')">üóëÔ∏è ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
            </div>
          </td>
        </tr>`
    }).join('');

    v.innerHTML = `
      <div class="card">
        <div class="row">
          <input id="search" placeholder="‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶® (‡¶®‡¶æ‡¶Æ/‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤)" />
          <select id="filterStatus">
            <option value="">‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</option>
            <option value="active">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü</option>
            <option value="inactive">‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü</option>
            <option value="disconnected">‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</option>
          </select>
          <button class="btn blue" onclick="openCustomerForm()">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</button>
        </div>
      </div>
      <div class="card" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>‡¶®‡¶æ‡¶Æ</th><th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th><th>ISP</th><th>‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú</th><th>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï</th><th>‡¶¨‡¶ï‡ßá‡ßü‡¶æ</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
            </tr>
          </thead>
          <tbody id="custRows">${rows}</tbody>
        </table>
      </div>
    `;

    // search/filter
    $('#search').oninput = $('#filterStatus').onchange = ()=>{
      const q = ($('#search').value||'').toLowerCase();
      const fs = $('#filterStatus').value;
      $$('#custRows tr').forEach(tr=>{
        const hay = tr.innerText.toLowerCase();
        const showQ = !q || hay.includes(q);
        const st = fs? tr.querySelector('.pill')?.classList.contains(fs) : true;
        tr.style.display = (showQ && st)? '' : 'none';
      });
    }
  }

  function openCustomerForm(id){
    const isEdit = !!id;
    const c = isEdit? DB.customers.find(x=>x.id===id) : {id:uid(), name:'', phone:'', address:'', status:'active', ispId:'', packageId:'', price:0, due:0, payments:[], lastBilledMonth: CURR_YM};
    const ispOptions = DB.isps.map(i=>`<option value="${i.id}" ${c.ispId===i.id?'selected':''}>${i.name}</option>`).join('');
    const pkgOptions = (DB.isps.find(i=>i.id===c.ispId)?.packages||[]).map(p=>`<option value="${p.id}" ${c.packageId===p.id?'selected':''}>${p.name} ‚Ä¢ ${p.speedMbps} Mbps ‚Ä¢ ${taka(p.price)}</option>`).join('');

    const html = `
      <div class="card">
        <h3>${isEdit? '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶è‡¶°‡¶ø‡¶ü' : '‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï'}</h3>
        <div class="row">
          <input id="f-name" placeholder="‡¶®‡¶æ‡¶Æ" value="${c.name||''}">
          <input id="f-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤" value="${c.phone||''}">
        </div>
        <div class="row">
          <select id="f-status">
            <option value="active" ${c.status==='active'?'selected':''}>‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü</option>
            <option value="inactive" ${c.status==='inactive'?'selected':''}>‡¶®‡¶ø‡¶∑‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡ßü</option>
            <option value="disconnected" ${c.status==='disconnected'?'selected':''}>‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°</option>
          </select>
          <input id="f-address" placeholder="‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" value="${c.address||''}">
        </div>
        <div class="row">
          <select id="f-isp"><option value="">ISP ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>${ispOptions}</select>
          <select id="f-pkg"><option value="">‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>${pkgOptions}</select>
          <input id="f-price" type="number" placeholder="‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)" value="${Number(c.price||0)}">
        </div>
        <div class="toolbar">
          <button class="btn primary" id="f-save">${isEdit?'‡¶∏‡ßá‡¶≠':'‡¶è‡¶°'}</button>
          <button class="btn" id="f-cancel">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        </div>
      </div>
    `;

    const v = $('#view-customers');
    v.innerHTML = html + v.innerHTML; // push on top

    $('#f-isp').onchange = (e)=>{
      const isp = DB.isps.find(i=>i.id===e.target.value);
      const pkgs = isp? isp.packages:[];
      $('#f-pkg').innerHTML = `<option value="">‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>` + pkgs.map(p=>`<option value="${p.id}">${p.name} ‚Ä¢ ${p.speedMbps} Mbps ‚Ä¢ ${taka(p.price)}</option>`).join('');
      if(pkgs[0]){
        $('#f-pkg').value = pkgs[0].id;
        $('#f-price').value = pkgs[0].price;
      }
    }
    $('#f-pkg').onchange = (e)=>{
      const isp = DB.isps.find(i=>i.id===($('#f-isp').value));
      const p = isp?.packages?.find(x=>x.id===e.target.value);
      if(p) $('#f-price').value = p.price;
    }

    $('#f-save').onclick = ()=>{
      c.name = $('#f-name').value.trim();
      c.phone = $('#f-phone').value.trim();
      c.address = $('#f-address').value.trim();
      c.status = $('#f-status').value;
      c.ispId = $('#f-isp').value || null;
      c.packageId = $('#f-pkg').value || null;
      c.price = Number($('#f-price').value)||0;
      if(isEdit){
        const idx = DB.customers.findIndex(x=>x.id===c.id);
        DB.customers[idx] = c;
      }else{
        DB.customers.push(c);
      }
      saveDB();
      renderCustomers();
      alert('‚úÖ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
    }
    $('#f-cancel').onclick = ()=> renderCustomers();
  }

  function toggleStatus(id){
    const c = DB.customers.find(x=>x.id===id);
    const order = ['active','inactive','disconnected'];
    const i = (order.indexOf(c.status)+1)%order.length;
    c.status = order[i];
    saveDB();
    renderCustomers();
  }
  function delCustomer(id){
    if(!confirm('‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) return;
    DB.customers = DB.customers.filter(x=>x.id!==id);
    saveDB();
    renderCustomers();
  }
  function pay(id){
    const c = DB.customers.find(x=>x.id===id);
    const amt = Number(prompt(`‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶®‡¶ø‡¶¨‡ßá‡¶®? (‡¶¨‡¶ï‡ßá‡ßü‡¶æ: ${c.due})`, c.due||0));
    if(!amt) return;
    c.due = Math.max(0,(c.due||0)-amt);
    c.payments = c.payments||[];
    c.payments.push({id:uid(), amount:amt, date:new Date().toISOString()});
    saveDB();
    renderCustomers();
  }
  window.pay = pay; window.toggleStatus = toggleStatus; window.delCustomer = delCustomer; window.openCustomerForm = openCustomerForm;

  // ======= ISPs & Packages =======
  function renderISPs(){
    const v = $('#view-isps');
    v.innerHTML = `
      <div class="card">
        <div class="toolbar">
          <button class="btn blue" onclick="openISPForm()">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ISP</button>
        </div>
      </div>
      ${DB.isps.map(i=>`
        <div class="card">
          <h3>${i.name} <span class="mono">#${i.id}</span></h3>
          <div class="row">
            <input id="n-${i.id}" placeholder="ISP ‡¶®‡¶æ‡¶Æ" value="${i.name}">
            <button class="btn primary" onclick="saveISPName('${i.id}')">‡¶∏‡ßá‡¶≠</button>
            <button class="btn danger" onclick="deleteISP('${i.id}')">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
          </div>
          <h3 style="margin-top:10px">‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú</h3>
          <div>
            ${i.packages.map(p=>`
              <div class="stat">
                <div><strong>${p.name}</strong> ‚Äî ${p.speedMbps} Mbps ‚Äî ${taka(p.price)} <span class="mono">#${p.id}</span></div>
                <div class="row" style="max-width:320px">
                  <button class="btn" onclick="editPkg('${i.id}','${p.id}')">‚úèÔ∏è ‡¶è‡¶°‡¶ø‡¶ü</button>
                  <button class="btn danger" onclick="delPkg('${i.id}','${p.id}')">üóëÔ∏è</button>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="row" style="margin-top:10px">
            <input id="pn-${i.id}" placeholder="‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡¶æ‡¶Æ">
            <input id="ps-${i.id}" type="number" placeholder="‡¶∏‡ßç‡¶™‡¶ø‡¶° (Mbps)">
            <input id="pp-${i.id}" type="number" placeholder="‡¶¶‡¶æ‡¶Æ (‡ß≥)">
            <button class="btn blue" onclick="addPkg('${i.id}')">‚ûï ‡¶Ø‡ßã‡¶ó</button>
          </div>
        </div>
      `).join('')}
    `;
  }
  function openISPForm(){
    const name = prompt('ISP ‡¶®‡¶æ‡¶Æ?');
    if(!name) return;
    DB.isps.push({id:uid(), name, packages:[]});
    saveDB();
    renderISPs();
  }
  function saveISPName(id){
    const el = document.getElementById('n-'+id);
    const isp = DB.isps.find(i=>i.id===id);
    isp.name = el.value.trim()||isp.name;
    saveDB();
    renderISPs();
  }
  function deleteISP(id){
    if(!confirm('ISP ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) return;
    DB.isps = DB.isps.filter(i=>i.id!==id);
    // detach from customers
    DB.customers.forEach(c=>{ if(c.ispId===id){ c.ispId=null; c.packageId=null; }});
    saveDB();
    renderISPs();
  }
  function addPkg(ispId){
    const name = document.getElementById('pn-'+ispId).value.trim();
    const speed = Number(document.getElementById('ps-'+ispId).value||0);
    const price = Number(document.getElementById('pp-'+ispId).value||0);
    if(!name) return alert('‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®');
    const isp = DB.isps.find(i=>i.id===ispId);
    isp.packages.push({id:uid(), name, speedMbps:speed, price});
    saveDB();
    renderISPs();
  }
  function editPkg(ispId,pkgId){
    const isp = DB.isps.find(i=>i.id===ispId);
    const p = isp.packages.find(x=>x.id===pkgId);
    const name = prompt('‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú ‡¶®‡¶æ‡¶Æ', p.name) || p.name;
    const speed = Number(prompt('‡¶∏‡ßç‡¶™‡¶ø‡¶° (Mbps)', p.speedMbps) || p.speedMbps);
    const price = Number(prompt('‡¶¶‡¶æ‡¶Æ (‡ß≥)', p.price) || p.price);
    Object.assign(p, {name, speedMbps:speed, price});
    saveDB();
    renderISPs();
  }
  function delPkg(ispId,pkgId){
    const isp = DB.isps.find(i=>i.id===ispId);
    isp.packages = isp.packages.filter(x=>x.id!==pkgId);
    // detach from customers if selected
    DB.customers.forEach(c=>{ if(c.packageId===pkgId){ c.packageId=null; }});
    saveDB();
    renderISPs();
  }
  window.openISPForm=openISPForm; window.saveISPName=saveISPName; window.deleteISP=deleteISP; window.addPkg=addPkg; window.editPkg=editPkg; window.delPkg=delPkg;

  // ======= OLT / ONU =======
  function renderOLTs(){
    const v = $('#view-olts');
    v.innerHTML = `
      <div class="card">
        <div class="toolbar">
          <button class="btn blue" onclick="openOLTForm()">‚ûï ‡¶®‡¶§‡ßÅ‡¶® OLT</button>
        </div>
      </div>
      ${DB.olts.map(o=>`
        <div class="card">
          <h3>${o.name} <span class="mono">#${o.id}</span></h3>
          <div class="row">
            <input id="on-${o.id}" placeholder="OLT ‡¶®‡¶æ‡¶Æ" value="${o.name}">
            <button class="btn primary" onclick="saveOLTName('${o.id}')">‡¶∏‡ßá‡¶≠</button>
            <button class="btn danger" onclick="deleteOLT('${o.id}')">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
          </div>
          <h3 style="margin-top:10px">ONU ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
          <div>
            ${o.onus.map(u=>`
              <div class="stat">
                <div><strong>${u.name}</strong> ‚Äî Rx Optical Power: <strong>${u.rx??'‚Äî'}</strong> dBm <span class="mono">#${u.id}</span></div>
                <div class="row" style="max-width:320px">
                  <button class="btn" onclick="editONU('${o.id}','${u.id}')">‚úèÔ∏è</button>
                  <button class="btn danger" onclick="delONU('${o.id}','${u.id}')">üóëÔ∏è</button>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="row" style="margin-top:10px">
            <input id="un-${o.id}" placeholder="ONU ‡¶®‡¶æ‡¶Æ">
            <input id="ur-${o.id}" type="number" step="0.01" placeholder="Rx Power (dBm)">
            <button class="btn blue" onclick="addONU('${o.id}')">‚ûï ONU ‡¶Ø‡ßã‡¶ó</button>
          </div>
        </div>
      `).join('')}
    `;
  }
  function openOLTForm(){
    const name = prompt('OLT ‡¶®‡¶æ‡¶Æ?');
    if(!name) return;
    DB.olts.push({id:uid(), name, onus:[]});
    saveDB();
    renderOLTs();
  }
  function saveOLTName(id){
    const o = DB.olts.find(x=>x.id===id);
    o.name = document.getElementById('on-'+id).value.trim()||o.name;
    saveDB();
    renderOLTs();
  }
  function deleteOLT(id){
    if(!confirm('OLT ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')) return;
    DB.olts = DB.olts.filter(x=>x.id!==id);
    saveDB();
    renderOLTs();
  }
  function addONU(oltId){
    const name = document.getElementById('un-'+oltId).value.trim();
    const rx = parseFloat(document.getElementById('ur-'+oltId).value);
    if(!name) return alert('ONU ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®');
    const o = DB.olts.find(x=>x.id===oltId);
    o.onus.push({id:uid(), name, rx});
    saveDB();
    renderOLTs();
  }
  function editONU(oltId, onuId){
    const o = DB.olts.find(x=>x.id===oltId);
    const u = o.onus.find(x=>x.id===onuId);
    const name = prompt('ONU ‡¶®‡¶æ‡¶Æ', u.name) || u.name;
    const rx = parseFloat(prompt('Rx Power (dBm)', u.rx??'') || u.rx);
    Object.assign(u,{name, rx});
    saveDB();
    renderOLTs();
  }
  function delONU(oltId, onuId){
    const o = DB.olts.find(x=>x.id===oltId);
    o.onus = o.onus.filter(x=>x.id!==onuId);
    saveDB();
    renderOLTs();
  }
  window.openOLTForm=openOLTForm; window.saveOLTName=saveOLTName; window.deleteOLT=deleteOLT; window.addONU=addONU; window.editONU=editONU; window.delONU=delONU;

  // ======= Backup / Restore =======
  function renderBackup(){
    const v = $('#view-backup');
    v.innerHTML = `
      <div class="grid cols-2">
        <div class="card">
          <h3>‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</h3>
          <p>‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§</p>
          <button class="btn primary" id="btn-backup">‚¨áÔ∏è ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
        </div>
        <div class="card">
          <h3>‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</h3>
          <p>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
          <input type="file" id="file-restore" accept="application/json">
          <div class="toolbar" style="margin-top:10px">
            <button class="btn warn" id="btn-restore">‚¨ÜÔ∏è ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</button>
            <button class="btn danger" id="btn-clear">‚ùå ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
          </div>
        </div>
      </div>
    `;

    $('#btn-backup').onclick = ()=>{
      const blob = new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ibill-backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    $('#btn-restore').onclick = ()=>{
      const f = $('#file-restore').files?.[0];
      if(!f) return alert('‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®');
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          DB = data; saveDB();
          alert('‚úÖ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
          location.reload();
        }catch(e){ alert('‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü'); }
      }
      reader.readAsText(f);
    }
    $('#btn-clear').onclick = ()=>{
      if(!confirm('‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')) return;
      localStorage.removeItem(DB_KEY);
      DB = structuredClone(defaultDB);
      saveDB();
      location.reload();
    }
  }

  // ======= Help =======
  function renderHelp(){
    const v = $('#view-help');
    v.innerHTML = `
      <div class="card">
        <h3>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶¨‡¶ø‡¶ß‡¶ø</h3>
        <ul>
          <li><span class="kbd">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</span> ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶•‡ßá‡¶ï‡ßá Add/Edit ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ Active ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶Æ‡¶æ‡¶∏‡ßá ‡¶Ö‡¶ü‡ßã ‡¶¨‡¶ø‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá‡•§</li>
          <li>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶§‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶™‡¶æ‡¶∂‡ßá <b>üí≥ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</b> ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶Ü‡¶Ç‡¶∂‡¶ø‡¶ï/‡¶™‡ßÇ‡¶∞‡ßç‡¶£‚Äî‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®‡•§</li>
          <li><span class="kbd">ISP/‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú</span> ‡¶è ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡ß™‡¶ü‡¶ø ISP ‡¶ì ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú/‡¶¶‡¶æ‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
          <li><span class="kbd">OLT/ONU</span> ‡¶è ONU ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá Rx Optical Power (dBm) ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§</li>
          <li><span class="kbd">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™/‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞</span> ‡¶•‡ßá‡¶ï‡ßá JSON ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡¶ø‡¶® ‡¶¨‡¶æ ‡¶™‡ßÅ‡¶®‡¶∞‡ßÅ‡¶¶‡ßç‡¶ß‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</li>
          <li>‡¶∏‡¶¨‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ <i>LocalStorage</i> ‡¶è ‡¶∏‡ßá‡¶≠ ‡¶•‡¶æ‡¶ï‡ßá ‚Äî ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶õ‡¶æ‡ßú‡¶æ‡¶á ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá‡•§</li>
        </ul>
        <p class="mono">‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®: 1.0 ‚Ä¢ ‡¶Ö‡¶ü‡ßã-‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶Æ‡¶æ‡¶∏ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶π‡ßü‡•§ ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßá ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá "‡¶Ö‡¶ü‡ßã ‡¶¨‡¶ø‡¶≤ ‡¶ö‡¶æ‡¶≤‡¶æ‡¶®" ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®‡•§</p>
      </div>
    `;
  }

  // ======= New OLT quick from Dashboard =======
  function openOLTForm(){
    const name = prompt('OLT ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®');
    if(!name) return;
    DB.olts.push({id:uid(), name, onus:[]});
    saveDB();
    renderOLTs();
  }

  // init
  renderTabs();
  </script>

  <footer class="footer wrap">Made for you ‚Äî single-file, offline, autosave. üß°</footer>
</body>
</html>
